var __create = Object.create;
var __defProp = Object.defineProperty;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __markAsModule = (target) => __defProp(target, "__esModule", {value: true});
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, {get: all[name], enumerable: true});
};
var __exportStar = (target, module2, desc) => {
  if (module2 && typeof module2 === "object" || typeof module2 === "function") {
    for (let key of __getOwnPropNames(module2))
      if (!__hasOwnProp.call(target, key) && key !== "default")
        __defProp(target, key, {get: () => module2[key], enumerable: !(desc = __getOwnPropDesc(module2, key)) || desc.enumerable});
  }
  return target;
};
var __toModule = (module2) => {
  return __exportStar(__markAsModule(__defProp(module2 != null ? __create(__getProtoOf(module2)) : {}, "default", module2 && module2.__esModule && "default" in module2 ? {get: () => module2.default, enumerable: true} : {value: module2, enumerable: true})), module2);
};

// packages/@lwrjs/view-registry/src/view-handler.ts
__markAsModule(exports);
__export(exports, {
  LwrViewHandler: () => LwrViewHandler
});
var import_shared_utils = __toModule(require("@lwrjs/shared-utils"));
var import_utils = __toModule(require("./utils.cjs"));
var import_path = __toModule(require("path"));
var LwrViewHandler = class {
  constructor(context, globalConfig) {
    this.inflightRouteHandlerEvalMap = new Map();
    this.routeHandlerFunctionMap = new Map();
    this.viewRegistry = context.viewRegistry;
    this.globalConfig = globalConfig;
    this.moduleRegistry = context.moduleRegistry;
  }
  async getViewContent(viewRequest, route, runtimeEnvironment, runtimeParams = {}) {
    const {routeHandler} = route;
    if (routeHandler) {
      const response = await this.getRouteHandlerResponse(viewRequest, route, runtimeEnvironment, runtimeParams);
      if ((0, import_utils.isViewResponse)(response)) {
        return response;
      }
      const {view, viewParams, renderOptions} = normalizeViewProperties(viewRequest, response, route, this.globalConfig);
      const viewDefinition2 = await this.viewRegistry.getViewDefinition(view, viewParams, runtimeEnvironment, {
        ...runtimeParams,
        params: viewRequest.params,
        query: viewRequest.query
      }, renderOptions);
      return {
        ...response,
        body: viewDefinition2.renderedView,
        metadata: {
          viewDefinition: viewDefinition2
        }
      };
    }
    const viewDefinition = await this.getDefaultRouteViewDefinition(viewRequest, route, runtimeEnvironment, runtimeParams);
    return {
      body: viewDefinition.renderedView,
      metadata: {
        viewDefinition
      }
    };
  }
  async getViewJson(viewRequest, route, runtimeEnvironment, runtimeParams = {}) {
    const {routeHandler} = route;
    if (routeHandler) {
      const response = await this.getRouteHandlerResponse(viewRequest, route, runtimeEnvironment, runtimeParams);
      if ((0, import_utils.isViewResponse)(response)) {
        return response;
      }
      const {view, viewParams, renderOptions} = normalizeViewProperties(viewRequest, response, route, this.globalConfig);
      const viewDefinition2 = await this.viewRegistry.getViewDefinition(view, viewParams, runtimeEnvironment, runtimeParams, renderOptions);
      return {
        ...response,
        ...await (0, import_utils.toJsonFormat)(viewRequest, viewDefinition2, route, runtimeEnvironment, runtimeParams, this.moduleRegistry)
      };
    }
    const viewDefinition = await this.getDefaultRouteViewDefinition(viewRequest, route, runtimeEnvironment, runtimeParams);
    return await (0, import_utils.toJsonFormat)(viewRequest, viewDefinition, route, runtimeEnvironment, runtimeParams, this.moduleRegistry);
  }
  async getViewConfiguration(viewRequest, route, runtimeEnvironment, runtimeParams = {}) {
    const {routeHandler} = route;
    let viewDefinition;
    if (routeHandler) {
      const response = await this.getRouteHandlerResponse(viewRequest, route, runtimeEnvironment, runtimeParams);
      if ((0, import_utils.isViewResponse)(response)) {
        return;
      }
      const {view, viewParams, renderOptions} = normalizeViewProperties(viewRequest, response, route, this.globalConfig);
      viewDefinition = await this.viewRegistry.getViewDefinition(view, viewParams, runtimeEnvironment, runtimeParams, renderOptions);
    } else {
      viewDefinition = await this.getDefaultRouteViewDefinition(viewRequest, route, runtimeEnvironment, runtimeParams);
    }
    const bootstrapResources = viewDefinition.viewRecord.bootstrapModule?.resources;
    if (!bootstrapResources) {
      return;
    }
    const htmlResources = route.bootstrap?.configAsSrc ? bootstrapResources.map((resource) => resource.content).join("\n") : await (0, import_utils.generateHtmlTag)({
      type: "application/javascript",
      inline: true,
      content: bootstrapResources.map((resource) => resource.content).join("\n")
    });
    return {
      body: htmlResources
    };
  }
  async getDefaultRouteViewDefinition(viewRequest, route, runtimeEnvironment, runtimeParams = {}) {
    const {id, bootstrap, rootComponent, contentTemplate, layoutTemplate, properties} = route;
    const page = (0, import_utils.generatePageContext)(viewRequest, route);
    const viewDefinition = await this.viewRegistry.getViewDefinition({
      id,
      bootstrap,
      rootComponent,
      contentTemplate,
      layoutTemplate
    }, {page, ...properties}, runtimeEnvironment, {
      ...runtimeParams,
      params: viewRequest.params,
      query: viewRequest.query
    });
    return viewDefinition;
  }
  async getRouteHandlerResponse(viewRequest, route, runtimeEnvironment, runtimeParams = {}) {
    const {rootDir, assets, contentDir, layoutsDir, cacheDir} = this.globalConfig;
    const paths = {rootDir, assets, contentDir, layoutsDir};
    const {routeHandler} = route;
    if (!routeHandler) {
      throw new Error("Route Handler is required for a CustomView");
    }
    let routeHandlerFunction = this.routeHandlerFunctionMap.get(routeHandler);
    if (!routeHandlerFunction) {
      const inflightRouteHandlerPromise = this.inflightRouteHandlerEvalMap.get(routeHandler);
      if (inflightRouteHandlerPromise) {
        routeHandlerFunction = await inflightRouteHandlerPromise;
      } else {
        const handlerPromise = (0, import_utils.getRouteHandler)(routeHandler, {cacheDir, rootDir});
        this.inflightRouteHandlerEvalMap.set(routeHandler, handlerPromise);
        routeHandlerFunction = await handlerPromise;
      }
      this.routeHandlerFunctionMap.set(routeHandler, routeHandlerFunction);
      this.inflightRouteHandlerEvalMap.delete(routeHandler);
    }
    const locale = runtimeParams.locale;
    const viewApi = this.getBoundApi(route, runtimeEnvironment, runtimeParams);
    const response = await routeHandlerFunction({...viewRequest, locale}, {route, viewApi, ...paths});
    return response;
  }
  getBoundApi(route, runtimeEnvironment, runtimeParams) {
    return {
      getViewResponse: this.getViewResponse.bind(this, route, runtimeEnvironment, runtimeParams),
      hasViewResponse: this.hasViewResponse.bind(this, route, runtimeEnvironment, runtimeParams)
    };
  }
  hasViewResponse(route, runtimeEnvironment, runtimeParams = {}, view, viewParams, renderOptions) {
    const {id, bootstrap} = route;
    const managedView = {...view, id, bootstrap};
    return this.viewRegistry.hasViewDefinition(managedView, viewParams, runtimeEnvironment, runtimeParams, renderOptions);
  }
  async getViewResponse(route, runtimeEnvironment, runtimeParams = {}, view, viewParams, renderOptions) {
    const {id, bootstrap} = route;
    const managedView = {...view, id, bootstrap};
    const viewDefinition = await this.viewRegistry.getViewDefinition(managedView, viewParams, runtimeEnvironment, runtimeParams, renderOptions);
    return {
      body: viewDefinition.renderedView,
      metadata: {
        viewDefinition
      }
    };
  }
};
function normalizeViewProperties(viewRequest, response, route, config) {
  const {
    view: {rootComponent, contentTemplate: cTemplate, layoutTemplate: lTemplate},
    viewParams,
    renderOptions
  } = response;
  const {rootDir, assets, contentDir, layoutsDir} = config;
  const paths = {rootDir, assets, contentDir, layoutsDir};
  const page = (0, import_utils.generatePageContext)(viewRequest, {
    ...route,
    contentTemplate: cTemplate,
    properties: viewParams
  });
  const {id, bootstrap} = route;
  return {
    view: {
      id,
      bootstrap,
      ...rootComponent && {rootComponent},
      ...cTemplate && {contentTemplate: (0, import_path.resolve)((0, import_shared_utils.normalizeResourcePath)(cTemplate, paths))},
      ...lTemplate && {layoutTemplate: (0, import_path.resolve)((0, import_shared_utils.normalizeResourcePath)(lTemplate, paths))}
    },
    viewParams: {page, ...viewParams},
    renderOptions
  };
}
