{"version":3,"file":"simple_collector.js","sources":["../../../../src/simple_collector/SimpleCollector.ts"],"sourcesContent":["import {\n    CoreEnvelopeBuilder,\n    CoreEnvelopeContentsRaw,\n    LogMessageRaw,\n    StaticAttributes\n} from 'o11y/core_envelope';\nimport { LazyMapToList, SchematizedData, schemaUtil, utility } from 'o11y/shared';\nimport {\n    LogCollector,\n    LogMeta,\n    MetricsCollector,\n    MetricsExtractorMethods,\n    Schema\n} from '../interfaces';\nimport {\n    PrecollectCallbackType,\n    SimpleCollectorOptions\n} from './interfaces/SimpleCollectorOptions';\n\nconst defaultMaxUniqueSchemas = 10000;\n\nexport class SimpleCollector implements LogCollector, MetricsCollector {\n    private readonly _messageBuffers: LazyMapToList<Schema, LogMessageRaw>;\n    private readonly _staticAttributes: StaticAttributes;\n    private readonly _precollectCallback: PrecollectCallbackType;\n    private _metricsExtractors: MetricsExtractorMethods;\n    private _messageSize = 0;\n    private _isCollecting = false;\n\n    constructor(options?: SimpleCollectorOptions) {\n        let maxUniqueSchemas = defaultMaxUniqueSchemas;\n        if (options) {\n            const env = options.environment;\n            if (env) {\n                this._staticAttributes = {\n                    appName: env.appName,\n                    appVersion: env.appVersion,\n                    appExperience: env.appExperience,\n                    deviceId: env.deviceId,\n                    deviceModel: env.deviceModel,\n                    sdkVersion: env.sdkVersion\n                };\n            }\n\n            if (\n                utility.requireArgumentIfDefined(\n                    options.precollectCallback,\n                    'options.precollectCallback',\n                    'function'\n                )\n            ) {\n                this._precollectCallback = options.precollectCallback;\n            }\n\n            const mus: number = options.maxUniqueSchemas;\n            if (mus !== undefined) {\n                if (typeof mus !== 'number' || !(mus > 0)) {\n                    throw new Error('options.maxUniqueSchemas, if defined, must be > 0');\n                }\n                maxUniqueSchemas = mus;\n            }\n        }\n        this._messageBuffers = new LazyMapToList<Schema, LogMessageRaw>(maxUniqueSchemas);\n    }\n\n    collect(schema: Schema, data: SchematizedData, logMeta: LogMeta): void {\n        if (this._isCollecting) {\n            return;\n        }\n        this._isCollecting = true;\n        try {\n            const msg: LogMessageRaw = {\n                timestamp: logMeta.timestamp,\n                data,\n                age: utility.getAge(logMeta.timestamp),\n                rootId: logMeta.rootId,\n                seq: logMeta.sequence,\n                sseq: logMeta.schemaSequence,\n                loggerName: logMeta.loggerName,\n                pagePayload: logMeta.pagePayload,\n                loggerAppName: logMeta.loggerAppName,\n                connectionType: logMeta.connectionType,\n                appPayload: logMeta.appPayload\n            };\n\n            if (this._precollectCallback && this._precollectCallback(schema, msg) === false) {\n                return;\n            }\n\n            if (!this._messageBuffers.push(schema, msg)) {\n                throw new Error(\n                    `Buffer is full. Refusing schemaId ${schemaUtil.getSchemaId(schema)}`\n                );\n            }\n            this._messageSize += utility.estimateObjectSize(msg);\n        } finally {\n            this._isCollecting = false;\n        }\n    }\n\n    get estimatedByteSize(): number {\n        return this._messageSize + this.metricsCount * 8;\n    }\n\n    get hasData(): boolean {\n        return this.messagesCount > 0 || this.metricsCount > 0;\n    }\n\n    get messagesCount(): number {\n        return this._messageBuffers.totalItemCount;\n    }\n\n    get metricsCount(): number {\n        let count = 0;\n\n        if (this._metricsExtractors) {\n            count += this._metricsExtractors.getAllUpCounters()?.length || 0;\n            count += this._metricsExtractors.getAllValueRecorders()?.length || 0;\n            count += this._metricsExtractors.getAllBucketHistograms()?.length || 0;\n        }\n\n        return count;\n    }\n\n    getRawContentsOfCoreEnvelope(): CoreEnvelopeContentsRaw {\n        const contents: CoreEnvelopeContentsRaw = {\n            staticAttributes: this._staticAttributes,\n            messages: this._messageBuffers.getAllMessages(true)\n        };\n\n        if (this._metricsExtractors) {\n            contents.upCounters = CoreEnvelopeBuilder.getUpCounters(\n                this._metricsExtractors.getAllUpCounters(),\n                true\n            );\n            contents.valueRecorders = CoreEnvelopeBuilder.getValueRecorders(\n                this._metricsExtractors.getAllValueRecorders(),\n                true\n            );\n            contents.bucketHistograms = CoreEnvelopeBuilder.getBucketHistograms(\n                this._metricsExtractors.getAllBucketHistograms(),\n                true\n            );\n        }\n\n        this._messageSize = 0;\n        return contents;\n    }\n\n    receiveMetricsExtractors(metricsExtractors: MetricsExtractorMethods): void {\n        this._metricsExtractors = metricsExtractors;\n    }\n}\n"],"names":[],"mappings":"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"}